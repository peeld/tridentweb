{% extends "base.html" %}

{% block content %}
<section class="section">
  <div class="container">
    <div class="columns is-centered">
      <div class="column is-half">
        <h1 class="title has-text-centered">Make a payment</h1>
        <p class="subtitle has-text-centered">Enter your payment details below</p>

        {% if not user.is_authenticated %}
          <div class="box mb-5">
            <h2 class="subtitle">Have an account?</h2>
            <form method="POST">
              {% csrf_token %}
              <div class="field">
                <label class="label">Username</label>
                <div class="control">
                  <input type="text" name="username" class="input" required>
                </div>
              </div>
              <div class="field">
                <label class="label">Password</label>
                <div class="control">
                  <input type="password" name="password" class="input" required>
                </div>
              </div>
              <button type="submit" name="login" class="button is-link is-small">Log In</button>
              <p class="help">Or continue below as a guest.</p>
              {% if login_error %}
                <p class="help is-danger">{{ login_error }}</p>
              {% endif %}
            </form>
          </div>
        {% endif %}

        <div class="box">

<form id="payment-form">

  <div class="field">
    <label class="label">Item</label>
    <div class="control">
      {{ item_name }}
    </div>
  </div>


  <div class="field">
    <label class="label">Amount</label>
    <div class="control">
      <input id="amount" class="input is-static" type="text" value="{{ amount_display }}" readonly>
    </div>
    <p class="help">This is the total that will be charged.</p>
  </div>

  {% if not user.is_authenticated %}

  <!-- Email -->
  <div class="field">
    <label class="label">Email</label>
    <div class="control">
      <input id="email" class="input" type="text" placeholder="name@example.com" required>
    </div>
  </div>

  {% endif %}

  <!-- Cardholder Name -->
  <div class="field">
    <label class="label">Cardholder Name</label>
    <div class="control">
      <input id="cardholder-name" class="input" type="text" placeholder="Jane Doe" required>
    </div>
  </div>

  <!-- Card Number -->
  <div class="field">
    <label class="label">Card Number</label>
    <div class="control">
      <div id="card-number-element" class="stripe-input"></div>
    </div>
  </div>

  <!-- Expiry and CVC side by side -->
  <div class="field is-horizontal">
    <div class="field-body">
      <div class="field">
        <label class="label">Expiration Date</label>
        <div class="control">
          <div id="card-expiry-element" class="stripe-input"></div>
        </div>
      </div>
      <div class="field">
        <label class="label">CVC</label>
        <div class="control">
          <div id="card-cvc-element" class="stripe-input"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Postal Code -->
  <div class="field">
    <label class="label">Zip / Postal Code</label>
    <div class="control">
      <input id="card-postal" class="input" type="text" placeholder="12345" required>
    </div>
  </div>


  {% if user.is_authenticated %}

  <!-- Save for future use -->
  <div class="field mt-4">
    <div class="control">
      <label class="checkbox">
        <input type="checkbox" id="save-card" name="save_card">
        Save this card for future use
      </label>
    </div>


  </div>

  {% endif %}

  <div class="field mt-4">
      <p class="help">Your card details are securely processed by Stripe and never stored on our servers.</p>
  </div>

  <!-- Submit button -->
  <div class="field is-grouped is-grouped-right mt-4">
    <div class="control">
      <button id="submit" class="button is-primary">
        <span class="icon">
          <i class="fas fa-credit-card"></i>
        </span>
        <span>Submit Payment</span>
      </button>
    </div>
  </div>

</form>

          <!-- Message area -->
          <div id="payment-message" class="notification is-hidden mt-4"></div>
        </div>
      </div>
    </div>
  </div>
</section>

<style>
  .stripe-input {
  border: 1px solid #dbdbdb;
  border-radius: 4px;
  padding: 0.625em 0.75em;
  box-shadow: inset 0 1px 2px rgba(10,10,10,0.1);
  transition: border-color 0.2s;
}

.stripe-input:focus-within {
  border-color: #485fc7; /* Bulma primary */
}

</style>

<script src="https://js.stripe.com/v3/"></script>
<script>
  const stripe = Stripe("{{ STRIPE_PUBLISHABLE_KEY }}");
  const elements = stripe.elements();

  const cardNumber = elements.create("cardNumber");
  const cardExpiry = elements.create("cardExpiry");
  const cardCvc = elements.create("cardCvc");

  cardNumber.mount("#card-number-element");
  cardExpiry.mount("#card-expiry-element");
  cardCvc.mount("#card-cvc-element");

  const form = document.getElementById("payment-form");
  const messageDiv = document.getElementById("payment-message");

  form.addEventListener("submit", async (event) => {
    event.preventDefault();

    {% if user.is_authenticated %}
    const email = "{{ user.email }}";
    {% else %}
    const email = document.getElementById("email").value;
    {% endif %}

    const {error, paymentIntent} = await stripe.confirmCardPayment(
      "{{ client_secret }}",
      {
        payment_method: {
          card: cardNumber,
          billing_details: {
            name: document.getElementById("cardholder-name").value,
            email: email,
      },
        }
      }
    );

    if (error) {
      messageDiv.textContent = error.message;
      messageDiv.className = "has-text-danger";
    } else if (paymentIntent && paymentIntent.status === "succeeded") {
      messageDiv.textContent = "Payment successful!";
      messageDiv.className = "has-text-success";
    }
  });
</script>
{% endblock %}
